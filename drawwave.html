<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas to AudioBuffer</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <div id="canvas-container"></div>
    <button id="play-button">Play</button>
    <label for="speed-control">Speed:</label>
    <input type="range" id="speed-control" min="0.5" max="2" step="0.1" value="1">
    <script>
        class CanvasAudio {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.canvas = document.createElement('canvas');
                this.canvas.width = 128;
                this.canvas.height = this.canvas.width * 9 / 16;
                this.ctx = this.canvas.getContext('2d');
                this.container.appendChild(this.canvas);
                this.isDrawing = false;
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.playbackRate = 1;
                this.initCanvas();
                this.initSpeedControl();
            }

            initCanvas() {
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing());
                // this.canvas.addEventListener('mouseleave', () => this.stopDrawing());
            }

            initSpeedControl() {
                const speedControl = document.getElementById('speed-control');
                speedControl.addEventListener('input', (e) => {
                    this.playbackRate = e.target.value;
                });
            }

            startDrawing(event) {
                this.isDrawing = true;
                this.ctx.beginPath();
                this.ctx.moveTo(event.offsetX, event.offsetY);
            }

            draw(event) {
                if (!this.isDrawing) return;
                this.ctx.lineTo(event.offsetX, event.offsetY);
                this.ctx.stroke();
            }

            stopDrawing() {
                if (!this.isDrawing) return;
                this.isDrawing = false;
                this.ctx.closePath();
            }

            getCanvasData() {
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                const data = imageData.data;
                

                const audioBuffer = this.audioContext.createBuffer(1, 128, this.audioContext.sampleRate);
                const channelData = audioBuffer.getChannelData(0);

                for (let i = 0; i < this.canvas.width; i++) {
                    let highest = 0
                    for (let j = 0; j < this.canvas.height; j++) {
                        const imageData = this.ctx.getImageData(i, j, 1, 1);

                        let val = (imageData.data[0] + imageData.data[1] + imageData.data[2]) / 3
                        
                        if (val > highest) highest = val
                        // console.log(i, j, imageData.data, val)


                    }
                    console.log(i,highest)
                    channelData[i] = highest / 255; // Normalize pixel value to audio range
                }

                return audioBuffer;
            }

            playAudio() {
                const buffer = this.getCanvasData();

                const source = this.audioContext.createBufferSource();
                source.buffer = buffer;
                source.loop = true
                source.playbackRate.value = this.playbackRate;
                source.connect(this.audioContext.destination);
                source.start(0);
            }
        }

        const canvasAudio = new CanvasAudio('canvas-container');
        document.getElementById('play-button').addEventListener('click', () => canvasAudio.playAudio());
    </script>
</body>

</html>